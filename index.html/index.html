<script>
    let advancedOptions;
    let canvasEle;

    //simulation stuff
    let strainMode = "Elastoplastic";
    let deltaL = 0.0;
    let strain = 0.0;
    let particleMass = 1.0;
    let particleX = -0.9;
    let particleY = -0;
    let forceX = 0.0;
    let forceY = 0.0;
    let velocityX = 0.0;
    let velocityY = 0.0;
    let cableRadius = 1;
    let cableLength = 1;
    let yieldStrength = 215;
    let ultimateStrength = 505;
    let E = 193;

    let path = [];

    //statistic stuff
    let maxForce = 0.0;
    let time = 0;

    let formatForce = function(N) {
        let force = Math.abs(N);
        if(force < 0.001) {
            return Math.round(N * 1000000) + "uN";
        } else if(force < 1) {
            return Math.round(N * 1000) + "mN";
        } else if(force < 1000) {
            return Math.round(N) + "N";
        } else if(force < 1000000) {
            return Math.round(N / 1000) + "kN";
        }
    };

    let formatEnergy = function(J) {
        let energy = Math.abs(J);
        if(energy < 0.001) {
            return Math.round(J * 1000000) + "uJ";
        } else if(energy < 1) {
            return Math.round(J * 1000) + "mJ";
        } else if(energy < 1000) {
            return Math.round(J) + "J";
        } else if(energy < 1000000) {
            return Math.round(J / 1000) + "kJ";
        }
    };

    let getForce = function(strain) {
        return strain * E * 1000000000 * (cableRadius * cableRadius) * 0.000001;
    };

    let stepSim = function(deltaT) {
        let oldForceX = forceX;
        let oldForceY = forceY;

        forceX = 0.0;
        forceY = -9.81 * particleMass;

        let dist = Math.sqrt(particleX * particleX + particleY * particleY);
        if(dist > cableLength) {
            deltaL = dist - cableLength;
            strain = deltaL / cableLength;
            let force = getForce(strain);

            if(force > maxForce) maxForce = force;

            forceX = -force * particleX / dist;
            forceY = -force * particleY / dist;
        } else {
            forceX = 0;
            forceY = 0;
            deltaL = 0;
            strain = 0;
        }

        velocityX += forceX / particleMass * deltaT;
        velocityY += forceY / particleMass * deltaT - 9.81 * deltaT;


        particleX += velocityX * deltaT;
        particleY += velocityY * deltaT;

        //stability
        //velocityX *= 0.9999;
        //velocityY *= 0.9999;

        time += deltaT;


        path.push({'x': particleX, 'y': particleY, 'f': Math.sqrt(forceX * forceX + forceY * forceY), 'fx': forceX, 'fy': forceY, 't': time});
    };

    let drawSim = function(forceInterval = 0.05) {
        let ctx = canvasEle.getContext('2d');


        let scale = canvasEle.height / 2;
        ctx.resetTransform();
        ctx.clearRect(0, 0, canvasEle.width, canvasEle.height);
        ctx.translate(canvasEle.width / 2, 10);
        ctx.scale(700, 700);
        ctx.lineWidth = 0.002;

        let forceScale = 0.01;

        //draw grid
        ctx.strokeStyle = "#ccc";
        for (let x = -100; x < 100; x++) {
            ctx.beginPath();
            ctx.moveTo(x, -100);
            ctx.lineTo(x, 100);
            ctx.stroke();
        }
        for (let y = -100; y < 100; y++) {
            ctx.beginPath();
            ctx.moveTo(-100, y);
            ctx.lineTo(100, y);
            ctx.stroke();
        }
        
        ctx.font = "0.02px Consolas";
        for (let x = -100; x < 100; x++) {
            for (let y = -100; y < 100; y++) {

                ctx.fillText("x:" + x + "m", x + 0.001, y + 0.001);
                ctx.fillText("y:" + y + "m", x + 0.001, y + 0.019);
            }
        }

        let lastTime = 0;
        for (let i = 1; i < path.length - 1; i++) {
            if (document.getElementById("drawPath").checked) {
                ctx.strokeStyle = "#aaa";
                ctx.beginPath();
                ctx.moveTo(path[i].x, -path[i].y);
                ctx.lineTo(path[i + 1].x, -path[i + 1].y);
                ctx.stroke();
            }


            if (path[i - 1].f != 0 || path[i].f != 0 || path[i + 1].f != 0) {
                if (document.getElementById("drawForce").checked) {
                    ctx.strokeStyle = "#faa";
                    ctx.beginPath();
                    ctx.moveTo(path[i].x +     path[i].fx * forceScale,     -path[i].y -     path[i].fy * forceScale);
                    ctx.lineTo(path[i + 1].x + path[i + 1].fx * forceScale, -path[i + 1].y - path[i + 1].fy * forceScale);
                    ctx.stroke();
                }

                if (document.getElementById("drawPeakForce").checked) {
                    if (path[i].f > path[i - 1].f && path[i].f > path[i + 1].f) {
                        ctx.strokeStyle = "#f77";
                        ctx.beginPath();
                        ctx.moveTo(path[i].x, -path[i].y);
                        ctx.lineTo(path[i].x + path[i].fx * forceScale, -path[i].y - path[i].fy * forceScale);
                        ctx.stroke();
                        ctx.font = "0.03px Consolas";
                        ctx.fillText(formatForce(path[i].f), path[i].x, -path[i].y);
                    }
                }
            }
        }


        //draw cable
        ctx.strokeStyle = "#000";
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(particleX, -particleY);
        ctx.stroke();

        //draw particle
        ctx.lineWidth = 0.004;
        ctx.beginPath();
        ctx.arc(particleX, -particleY, 10, 0, 2 * 3.141597);
        ctx.stroke();

        //draw reaction force vector
        ctx.strokeStyle = "#f00";
        ctx.beginPath();
        ctx.moveTo(particleX, -particleY);
        ctx.lineTo(particleX + forceX * forceScale, -particleY - forceY * forceScale);
        ctx.stroke();

        updateInfo();
    };

    let updateInfo = function() {
        document.getElementById("currentForceX").innerText = "X Force: " + formatForce(forceX);
        document.getElementById("currentForceY").innerText = "Y Force: " + formatForce(forceY);
        document.getElementById("maxForce").innerText = "Maximum Force: " + formatForce(maxForce);

        let potentialEnergy = particleMass * particleY * 9.81;
        let kineticEnergy = 0.5 * particleMass * (velocityX * velocityX + velocityY * velocityY);
        let elasticEnergy = 0;

        //integration
        let segments = 100;
        for(let i = 0; i < deltaL; i += (deltaL / segments)) elasticEnergy += getForce(i / cableLength);
        elasticEnergy = elasticEnergy * (deltaL / segments);


        let dissipatedEnergy = potentialEnergy + kineticEnergy + elasticEnergy;

        document.getElementById("currentStrain").innerText = strain;
        document.getElementById("potentialEnergy").innerText =
            "Potential Energy: " + formatEnergy(potentialEnergy);
        document.getElementById("kineticEnergy").innerText =
            "Kinetic Energy: " + formatEnergy(kineticEnergy);
        document.getElementById("elasticEnergy").innerText =
            "Elastic Energy: " + formatEnergy(elasticEnergy);
        document.getElementById("dissipatedEnergy").innerText =
            "Î”Energy: " + formatEnergy(dissipatedEnergy);

        document.getElementById("time").innerText = "Time: " + Math.round(time * 1000) / 1000 + "s";
    };

    let showHide = function(panel) {
        let ele = document.getElementById(panel);
        let headerEle = null;
        let toggleEle = null;
        if (ele) {
            for (let i = 0; i < ele.childNodes.length; i++) {
                if (ele.childNodes[i].className == "panelHeader") {
                    headerEle = ele.childNodes[i];
                    break;
                }
            }
            if (headerEle) {
                for (let i = 0; i < headerEle.childNodes.length; i++) {
                    if (headerEle.childNodes[i].className == "panelShowHide") {
                        toggleEle = headerEle.childNodes[i];
                        break;
                    }
                }

                if (toggleEle) {
                    if (toggleEle.innerText == "Hide") {
                        toggleEle.innerText = "Show";
                        for (let i = 0; i < ele.childNodes.length; i++) {
                            if(ele.childNodes[i].className != "panelHeader" && ele.childNodes[i].style) ele.childNodes[i].style.display = 'none';
                        }
                    } else {
                        toggleEle.innerText = "Hide";
                        for (let i = 0; i < ele.childNodes.length; i++) {
                            if (ele.childNodes[i].className != "panelHeader" && ele.childNodes[i].style) ele.childNodes[i].style.display = 'initial';
                        }
                    }
                }
            }
        }
    };

    let updateVariable = function (variableName, inputID) {
        let ele = document.getElementById(inputID);
        let value = parseFloat(ele.value);
        let oldValue;
        eval('oldValue = ' + variableName);
        if (!isNaN(value)) {
            eval(variableName + " = " + value);
        } else {
            ele.value = oldValue;
        }
    };

    let resetSim = function () {
        particleX = parseFloat(document.getElementById("X0").value);
        particleY = parseFloat(document.getElementById("Y0").value);
        velocityX = 0;
        velocityY = 0;
        path = [];
    }

    window.onload = function () {
        document.getElementById("outerContainer").style.height = document.body.clientHeight + "px";

        advancedOptions = document.getElementById("advancedContent");
        canvasEle = document.getElementById("sim");

        canvasEle.width = document.body.clientWidth;
        canvasEle.height = document.body.clientHeight;

        let func;
        func = function() {
            for(let i = 0; i < 10; i++) stepSim(0.0001);
            drawSim();
            setTimeout(func, 10);
        };
        func();
    };
</script>

<style type="text/css">
    body {
        margin: 0;
    }

    .panel {
        width: 11em;
        display: flex;
        flex-direction: column;
        background-color: rgba(221, 221, 255, 0.60);
        padding: 3px;
        border: 1px solid #888;
        margin: 4px;
    }

    .panelHeader {
        display: flex;
        flex-direction: row;
        border-bottom: 2px solid #fff;
        padding-bottom: 2px;
        margin-bottom: 2px;
    }

    .panelShowHide {
        margin-left: 1em;
    }
</style>

<canvas id="sim" style="position: absolute; outline: 2px solid black; z-index: -1;"></canvas>
<div id="outerContainer" style="overflow-y: scroll;">
    <div class="panel">
        <button id="resetSimulation" style="width: 100%;" onclick="resetSim()">Reset Simulation</button>
        WARNING: The simulation may be unstable with certain parameters
    </div>
    <div id="level0options" class="panel">
        <div class="panelHeader">
            <b>Basic Sample Options</b>
            <button class="panelShowHide" onclick="showHide('level0options')">Hide</button>
        </div>
        <div style="display:flex; flex-direction:column;">
            Particle Mass (kg)
            <div style="display:flex; flex-direction:row;">
                <input id="ParticleMass" type="text" onblur="updateVariable('particleMass', 'ParticleMass')" value="1">
            </div>
        </div>
        <br>
        <div style="display:flex; flex-direction:column;">
            Cable Radius (mm)
            <div style="display:flex; flex-direction:row;">
                <input id="CableRadius" type="text" onblur="updateVariable('cableRadius', 'CableRadius')" value="1">
            </div>
        </div>
        <br>
        <div style="display:flex; flex-direction:column;">
            Cable Length (m)
            <div style="display:flex; flex-direction:row;">
                <input id="CableLength" type="text" onblur="updateVariable('cableLength', 'CableLength')" value="1">
            </div>
        </div>
        <br>
        <div style="display:flex; flex-direction:column;">
            X(t=0) (m)
            <div style="display:flex; flex-direction:row;">
                <input id="X0" type="text" value="-0.9">
            </div>
        </div>
        <br>
        <div style="display:flex; flex-direction:column;">
            Y(t=0) (m)
            <div style="display:flex; flex-direction:row;">
                <input id="Y0" type="text" value="0">
            </div>
        </div>
    </div>
    <div id="level1options" class="panel">
        <div class="panelHeader">
            <b>Advanced Sample Options</b>
            <button class="panelShowHide" onclick="showHide('level1options')">Hide</button>
        </div>
        <br>
        <div id="elastoplastic">
            <div style="display:flex; flex-direction:column;">
                Yield Strength (MPa)
                <div style="display:flex; flex-direction:row;">
                    <input id="YieldStrength" type="text" onblur="updateVariable('yieldStrength', 'YieldStrength')" value="215">
                </div>
            </div>
            <br>
            <div style="display:flex; flex-direction:column;">
                Ultimate Strength (MPa)
                <div style="display:flex; flex-direction:row;">
                    <input id="UltimateStrength" type="text" onblur="updateVariable('ultimateStrength', 'UltimateStrength')" value="505">
                </div>
            </div>
            <br>
            <div style="display:flex; flex-direction:column;">
                Modulus of Elasticity (GPa)
                <div style="display:flex; flex-direction:row;">
                    <input id="Modulus" type="text" onblur="updateVariable('E', 'Modulus')" value="193">
                </div>
            </div>
        </div>
    </div>
    <div id="stats" class="panel">
        <div class="panelHeader">
            <b>Statistics And Info</b>
            <button class="panelShowHide" onclick="showHide('stats')">Hide</button>
        </div>
        <div id="currentForceX">X Force: 0 N</div>
        <div id="currentForceY">Y Force: 0 N</div>
        <div id="currentStrain">Strain: 0 E-6</div>
        <div id="potentialEnergy">Potential Energy: 0 J</div>
        <div id="kineticEnergy">Kinetic Energy: 0 J</div>
        <div id="elasticEnergy">Elastic Energy: 0 J</div>
        <b>Statistics</b>
        <div id="time">Time: 0s</div>
        <div id="dissipatedEnergy">Total Dissipated Energy: 0 J</div>
        <div id="safeyFactor">Safety Factor: 1</div>
        <div id="maxForce">Maximum Force: 0 N</div>
    </div>
    <div id="simOptions" class="panel">
        <div class="panelHeader">
            <b>Simulation Settings</b>
            <button class="panelShowHide" onclick="showHide('simOptions')">Hide</button>
        </div>
        <button id="playPauseSimulation" onclick="drawSim()">Run Simulation</button>
        <button id="singleStep" onclick="stepSim(0.01)">Stem Simulation (1ms)</button>
        <select id="simulationMode">
            <option value="Real Time">Real Time</option>
            <option value="Max Speed">Max Speed</option>
        </select>
        <input type="checkbox" id="drawPath" checked="checked">Draw Path
        <input type="checkbox" id="drawForce" checked="checked">Draw Force
        <input type="checkbox" id="drawPeakForce" checked="checked">Draw Peak Force
    </div>
</div>
